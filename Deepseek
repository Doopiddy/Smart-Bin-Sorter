#include <WiFi.h>
#include <ESP32Servo.h>
#include <WebServer.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>

// WiFi credentials
const char* ssid = "PLDTHOMEFIBRJAWS5";
const char* password = "RVN*7Ven+s_2001";

// Pin definitions
#define SERVO1_PIN        33
#define SERVO2_PIN        4
#define GAS_SENSOR1_PIN   32
#define GAS_SENSOR2_PIN   23
#define ULTRASONIC1_ECHO  12
#define ULTRASONIC1_TRIG  13
#define ULTRASONIC2_ECHO  19
#define ULTRASONIC2_TRIG  18

// LCD Configuration (I2C)
#define LCD_ADDR    0x27
#define LCD_COLS    16
#define LCD_ROWS    2

// Servo positions
#define SERVO_CENTER      90
#define SERVO_LEFT1       45    // Servo 1 left position
#define SERVO_RIGHT1      135   // Servo 1 right position
#define SERVO_LEFT2       135   // Servo 2 left position (mirrored)
#define SERVO_RIGHT2      45    // Servo 2 right position (mirrored)

// Gas sensor constants
#define VCC               3.3
#define RL                10.0
#define RS_AIR            20.0
#define CALIBRATION_SAMPLES 50

Servo servo1;
Servo servo2;
WebServer server(80);
LiquidCrystal_I2C lcd(LCD_ADDR, LCD_COLS, LCD_ROWS);

float airQualityThreshold = 100.0;
float rsAirCalibrated = RS_AIR;
String localIP;

void setup() {
  Serial.begin(115200);
  
  // Initialize sensors and actuators
  pinMode(GAS_SENSOR1_PIN, INPUT);
  pinMode(GAS_SENSOR2_PIN, INPUT);
  pinMode(ULTRASONIC1_TRIG, OUTPUT);
  pinMode(ULTRASONIC1_ECHO, INPUT);
  pinMode(ULTRASONIC2_TRIG, OUTPUT);
  pinMode(ULTRASONIC2_ECHO, INPUT);

  // Attach servos
  servo1.attach(SERVO1_PIN);
  servo2.attach(SERVO2_PIN);
  centerServos();

  // Initialize LCD
  lcd.init();
  lcd.backlight();
  
  // Calibrate gas sensors
  Serial.println("Calibrating MQ-135 sensors...");
  delay(10000);  // Warm-up time for sensors
  rsAirCalibrated = calibrateMQ135();
  Serial.println("Calibrated Rs: " + String(rsAirCalibrated));

  // Connect to WiFi
  connectToWiFi();

  // Initialize web server
  setupWebServer();

  Serial.println("System Ready!");
  updateLCD();
}

void loop() {
  server.handleClient();
  updateSensors();
  delay(100);
}

void connectToWiFi() {
  WiFi.begin(ssid, password);
  
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Connecting WiFi");
  
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.println("Connecting to WiFi...");
    lcd.setCursor(0, 1);
    lcd.print("Status: Trying...");
  }

  localIP = WiFi.localIP().toString();
  Serial.println("WiFi connected!");
  Serial.print("Device IP: ");
  Serial.println(localIP);
}

void setupWebServer() {
  server.on("/", handleRoot);
  server.on("/left", handleLeft);
  server.on("/right", handleRight);
  server.on("/center", handleCenter);
  server.on("/air-quality", handleAirQuality);
  server.on("/distance", handleDistance);
  server.on("/status", handleStatus);
  
  server.begin();
}

void updateLCD() {
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("IP:");
  lcd.print(localIP);
  lcd.setCursor(0, 1);
  lcd.print("Ready for commands");
}

void updateSensors() {
  // This would be called periodically to update sensor readings
  // Add your sensor update logic here
}

// Servo control functions
void centerServos() {
  servo1.write(SERVO_CENTER);
  servo2.write(SERVO_CENTER);
}

void moveLeft() {
  servo1.write(SERVO_LEFT1);
  servo2.write(SERVO_LEFT2);
}

void moveRight() {
  servo1.write(SERVO_RIGHT1);
  servo2.write(SERVO_RIGHT2);
}

// Web server handlers
void handleRoot() {
  String html = "<html><body>";
  html += "<h1>Waste Sorting System</h1>";
  html += "<p>IP: " + localIP + "</p>";
  html += "<p><a href='/left'>Move Left</a></p>";
  html += "<p><a href='/right'>Move Right</a></p>";
  html += "<p><a href='/center'>Center</a></p>";
  html += "<p><a href='/air-quality'>Air Quality</a></p>";
  html += "<p><a href='/distance'>Distance</a></p>";
  html += "</body></html>";
  server.send(200, "text/html", html);
}

void handleLeft() {
  moveLeft();
  server.send(200, "text/plain", "Moved left");
  updateLCD();
}

void handleRight() {
  moveRight();
  server.send(200, "text/plain", "Moved right");
  updateLCD();
}

void handleCenter() {
  centerServos();
  server.send(200, "text/plain", "Centered");
  updateLCD();
}

void handleAirQuality() {
  float quality1 = readMQ135(GAS_SENSOR1_PIN);
  float quality2 = readMQ135(GAS_SENSOR2_PIN);
  String response = "{\"sensor1\":" + String(quality1) + ",\"sensor2\":" + String(quality2) + "}";
  server.send(200, "application/json", response);
}

void handleDistance() {
  long dist1 = getDistance(ULTRASONIC1_TRIG, ULTRASONIC1_ECHO);
  long dist2 = getDistance(ULTRASONIC2_TRIG, ULTRASONIC2_ECHO);
  String response = "{\"sensor1\":" + String(dist1) + ",\"sensor2\":" + String(dist2) + "}";
  server.send(200, "application/json", response);
}

void handleStatus() {
  String status = "{\"ip\":\"" + localIP + "\",\"status\":\"running\"}";
  server.send(200, "application/json", status);
}

// Sensor functions
float readMQ135(int pin) {
  int analogValue = analogRead(pin);
  float voltage = analogValue * (VCC / 4095.0);
  float rs = RL * (VCC - voltage) / voltage;
  return rs / rsAirCalibrated;
}

float calibrateMQ135() {
  float rsSum = 0;
  for (int i = 0; i < CALIBRATION_SAMPLES; i++) {
    int analogValue = analogRead(GAS_SENSOR1_PIN);
    float voltage = analogValue * (VCC / 4095.0);
    rsSum += RL * (VCC - voltage) / voltage;
    delay(100);
  }
  return rsSum / CALIBRATION_SAMPLES;
}

long getDistance(int trigPin, int echoPin) {
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);
  long duration = pulseIn(echoPin, HIGH);
  return duration * 0.034 / 2;
}
